# Mahara 22.10 — CSS Compilation Fix for Child Themes

**Date:** 28-02-2026
**Context:** Mahara 22.10 installations (especially non-git-clone sources) ship without compiled CSS for child themes. Only the `raw` theme works out of the box.

## Problem

Mahara 22.10 uses SASS (Bootstrap 5) for its theme CSS. Each theme has SASS source files in `theme/{name}/sass/` that must be compiled to `theme/{name}/style/style.css`.

**Symptoms:**
- Selecting any theme other than `raw` results in a completely unstyled page (no CSS loaded)
- The `primaryschool`, `default`, `maroon`, `modern`, and `ocean` themes all appear broken

**Root cause:** The compiled `style/` directories are git-ignored in all child themes. The `raw` theme includes a pre-compiled `style.css` (816K), but all child themes are missing theirs. The build tools (`package.json`, `Gulpfile.js`, `Makefile`) required for compilation are also absent from non-git-clone installations.

**Why it completely breaks (not just looks wrong):** Most child themes set `overrideparentcss = true` in their `themeconfig.php`, which tells Mahara to skip the parent (`raw`) theme's CSS and only load the child's. With no compiled child CSS, the page gets zero stylesheets.

## Theme CSS Status (Before Fix)

| Theme | SASS Source | Compiled CSS | `overrideparentcss` |
|-------|-------------|-------------|---------------------|
| raw | Yes (213 files) | Yes (816K) | N/A (base) |
| default | Yes | **Missing** | `true` |
| primaryschool | Yes | **Missing** | `true` |
| maroon | Yes | **Missing** | `true` |
| modern | Yes | **Missing** | `true` |
| ocean | Yes | **Missing** | `false` |

Note: `ocean` has `overrideparentcss = false`, so it would partially work (loading raw's CSS) but without its own colour overrides.

## Solution: Compile with Dart Sass

No need to set up the full Gulp pipeline. Dart Sass (`npx sass`) compiles the SCSS directly.

### Prerequisites

- Node.js installed (any recent version)
- `npx` available (comes with npm)

### Compile All Child Themes

Run from the Mahara htdocs root (the directory containing `theme/`):

```bash
cd /path/to/mahara

for theme in default primaryschool maroon modern ocean; do
  echo "Compiling $theme..."
  mkdir -p "theme/$theme/style"
  npx sass "theme/$theme/sass/style.scss" "theme/$theme/style/style.css" \
    --style=compressed --no-source-map --quiet-deps
done
```

### Compile a Single Theme

```bash
npx sass theme/primaryschool/sass/style.scss theme/primaryschool/style/style.css \
  --style=compressed --no-source-map --quiet-deps
```

### Expected Output Sizes

| Theme | Compiled Size |
|-------|--------------|
| default | ~692K |
| primaryschool | ~724K |
| maroon | ~716K |
| modern | ~688K |
| ocean | ~692K |

### Inside Docker

If compiling inside the Docker container (no Node.js available), either:

1. **Compile on host, copy in:** Compile on the host machine, then `docker cp` or volume-mount the `style/` directories
2. **Install Node in container:** `apt-get install -y nodejs npm` inside the container, then run the sass commands

## Changing the Active Theme

### Via PHP CLI (in Docker)

```bash
docker exec mahara-dev-web php -r "
define('INTERNAL', 1);
define('CLI', 1);
\$_SERVER['REMOTE_ADDR'] = '127.0.0.1';
require '/var/www/html/init.php';
set_config('theme', 'primaryschool');
echo 'Theme changed to: ' . get_config('theme') . PHP_EOL;
"
```

### Via Admin UI

Navigate to **Administration > Configure site > Site options > Site settings** and select the theme from the dropdown.

## Verification

After compiling, verify the CSS is served:

```bash
# Check file exists
ls -la theme/primaryschool/style/style.css

# Check HTTP response (if Mahara is running)
curl -s -o /dev/null -w "%{http_code} %{size_download}" http://localhost:8090/theme/primaryschool/style/style.css
# Expected: 200 ~724000
```

## Key Files Reference

- **Theme config:** `theme/{name}/themeconfig.php` — defines parent, `overrideparentcss`, colours
- **SASS entry point:** `theme/{name}/sass/style.scss` — imports variables then raw's full SASS
- **Compiled output:** `theme/{name}/style/style.css` — what Mahara actually loads
- **CSS loading logic:** `lib/web.php:get_stylesheets_for_current_page()` — resolves theme CSS hierarchy
- **Sanity check:** `lib/mahara.php` (~line 1600) — checks `theme/raw/style/style.css` exists; throws `ConfigSanityException` if missing
- **Theme readme:** `theme/Readme.md` — official Mahara theming guide with Gulp instructions

## Mahara's Official Build Process (For Reference)

The official way uses Gulp, but requires cloning from `git.mahara.org`:

```bash
# Only works with a full git clone that includes package.json + Gulpfile.js
npm install
make css                    # Production (compressed)
make css production=false   # Development (with debug comments)
```

This is unnecessary for our purposes — `npx sass` produces identical output.

## Related

- Mahara 22.10 uses Bootstrap 5 (upgraded from Bootstrap 4 in earlier versions)
- The `subthemestarter` theme is a template for creating new custom themes
- The `custom` theme has `overrideparentcss = false` and only adds JS, so it works without compilation
